= Blueprint Hooking System

[IMPORTANT]
====
This feature slated for SML 3.11 has not been released yet, and is not in the `dev` branch yet!
The contents of this page will change frequently!
====

TODO move images from Imgur to docs

TODO intro description

== Creating a Hook Blueprint

Within the Unreal Editor, create a new Blueprint of the type "Blueprint Hook"

image::Development/ModLoader/BlueprintHooks/CreateBlueprintHook.png[Create Blueprint Hook Asset]

Create a new function to handle the logic of your hook. The first parameter should be the type of Blueprint you are hooking. Subsequent parameters should be ...idk... TODO

image::Development/ModLoader/BlueprintHooks/NewFunction.png[New Function]

TODO how to go between hook graph and function graphs

Go back to the Graph, right-click, and create the type of hook you want.
Each type has an on-hover tooltip that explains what it does.

image::Development/ModLoader/BlueprintHooks/CreateHook.png[Create Hook]

Fill out the drop-downs to specify what class's function you are hooking.

image::Development/ModLoader/BlueprintHooks/FillDropdowns.png[Fill dropdowns]

Add a Target Specifier. These have on-hover tooltips that explain what they do.

image::Development/ModLoader/BlueprintHooks/TargetSpecifierTooltip.png[Target Specifier with tooltip]

image::Development/ModLoader/BlueprintHooks/TargetSpecifierConnected.png[Target Specifier]

[id="Register"]
== Registering the Hook

Hooks must be registered in a
xref:Development/ModLoader/ModModules.adoc[Game Instance Module] to be applied in-game.
Create a Mod Game Instance Module if you don't already have one and add your new hook to the "Blueprint Hooks" array.

image::Development/ModLoader/BlueprintHooks/RegisterHook.png[Register Hook in Game Instance Module]

== Limitations and Workarounds

=== Latent Action Nodes

Because Blueprint Hooks exist as functions, some nodes you may be used to from Event Graphs are not available, including Latent Action nodes like Delay.

To work around this, implement your logic in an Event Graph somewhere else,
such as a Mod Subsystem
or your Mod Game World Module,
then calling that event from the Hook Function.

image::Development/ModLoader/BlueprintHooks/LatentActionWorkaround.png[Game World Module workaround]

== TODO

=== Blueprint Hook info

https://discord.com/channels/555424930502541343/562722670974599227/1359689684237680751

FBlueprintHookManager::HookBlueprintFunction -> Blueprint Hook blueprints
* can do matching instead of just instruction index (more stable ™️), and insert the hook before/after/replace the existing statement
  * the BP hooking internals are transpiling the bytecode, but transpiling is not exposed to the user
* hooks are defined in a Blueprint Hook blueprint where the graph can contain
  * target specifiers (matchers) - which statements/expressions to match
    * constant (can choose type and value)
    * function call
    * function entry/exit
    * function return value
    * property read/write
    * parent expression (takes another specifier as input)
    * operand (takes another specifier as input)
    * selector (first/single/all/stuff) (takes another specifier as input)
  * hooks - what to apply to the statements/expressions filtered above (takes target specifier chain as input)
    * insert (before/after/replace, will resolve to the statement if targeting an expression)
    * redirect (for replacing non-statement expressions, e.g. function call argument, must return same type)
    * they take a function to apply as the hook
      * the functions exist in the same hook blueprint
      * can have arguments with the same name as variables available in the hook (local variables, global variables, and temp variables like function return values - need to dump the BP function to see the temp names)
      * you can also write to the argument to write to the variable
      * special arguments:
        * Target (the object)
        * TargetReturnValue (ReturnValue of the of the hooked function, but renamed to avoid conflicts with this function's ReturnValue)
        * redirect hooks
          * OriginalValue
        * insert hooks
          * HookTarget (the expression targeted by the hook, if not a statement already)
          * AssignmentTarget (when hooking an assignment statement, the variable to assign to)

=== Hook Function info

For the hook function, the inputs will be mapped using their name to
* global variables - object instance
* local variables - function inputs, function locals, and function temps (which you can check for in a BP code dump, either `-DumpBlueprintPatchingResults` which generates pseudocode, or in FModel which generates a json very similar to the asset dump)
* Target - special hooking argument that resolves to the object instance the hooked function was running
* TargetReturnValue - special hooking argument that resolves to the hooked function's ReturnValue
* HookTarget - special hooking argument that resolves to the expression the hook was pointing to, if it wasn't pointing to a statement
* AssignmentTarget - special hooking argument that resolves to the variable on the left side of an assignment statement, if that's what was hooked
* OriginalValue - special hooking argument that resolves to the original value when using redirect hooks (replacing an expression inside a statement, rather than an insert hook which goes before/replace/after a statement), is required in this case
